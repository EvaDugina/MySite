<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <title>Неприкосновенна</title>

        <link
            rel="icon"
            href="./images/НЕПРИКОСНОВЕННА.jpg"
            type="image/x-icon"
        />
        <link
            rel="shortcut icon"
            href="./images/НЕПРИКОСНОВЕННА.jpg"
            type="image/x-icon"
        />

        <link rel="stylesheet" href="./css/style.css" />
        <link rel="stylesheet" href="./css/flash.css" />
        <link rel="stylesheet" href="./css/cursor.css" />
    </head>

    <body>
        <img
            id="img-cursor"
            class="img-cursor z-6"
            src="./images/default.png"
            alt="icon"
        />
        <div id="div-photo" class="div-photo">
            <div id="div-flash-4" class="div-flash z-3 d-none">
                <img
                    id="img-flash-4"
                    class="img-flash not-allowed-image"
                    src="./images/УКРАЛИ.jpg"
                    alt="УКРАЛИ"
                />
            </div>
            <div id="div-flash-3" class="div-flash z-3 d-none">
                <img
                    id="img-flash-3"
                    class="img-flash not-allowed-image"
                    src="./images/ОПЛОДОТВОРЕНИЕ.jpg"
                    alt="ОПЛОДОТВОРЕНИЕ"
                />
            </div>
            <div id="div-flash-2" class="div-flash z-3 d-none">
                <img
                    id="img-flash-2"
                    class="img-flash not-allowed-image"
                    src="./images/04.jpg"
                    alt="ВСПЫШКА"
                />
            </div>
            <div id="div-flash-1" class="div-flash z-3 d-none">
                <img
                    id="img-flash-1"
                    class="img-flash not-allowed-image"
                    src="./images/01_2.jpg"
                    alt="ВСПЫШКА"
                />
            </div>
            <div id="div-flash-0" class="div-flash z-3 d-none">
                <div id="div-flash-0-back" class="div-flash"></div>
            </div>
            <div id="div-point" class="div-point z-3"></div>
            <button id="btn-click" class="btn-click z-4">неприкосновенна</button>
            <img
                id="img-portrait"
                class="img-portrait not-allowed-image z-1"
                src="./images/НЕПРИКОСНОВЕННА.png"
                alt="НЕПРИКОСНОВЕННА"
            />
        </div>
    </body>

    <style>
        :root {
            cursor: none;
        }

        /*

        */

        #div-flash-0 {
            mix-blend-mode: exclusion;
            /* mix-blend-mode: plus-lighter; */
        }

        #div-flash-0-back {
            background-color: lemonchiffon;
            width: 99.5%;
            height: 98.5%;
            margin: 0.2%;
        }

        #img-flash-1 {
            height: 112%;
            top: -4.5%;
            left: -52%;
        }

        #img-flash-2 {
            height: 228%;
            top: -29%;
            left: -64%;
        }

        #img-flash-3 {
            height: 116%;
            top: -5%;
            left: -89.5%;
        }

        #img-flash-4 {
            height: 141%;
            top: 50%;
            left: 52%;
            align-self: center;
            transform: translate(-50%, -50%);
        }

        /*


        */

        #div-photo {
            width: 40vw;
        }

        #btn-click {
            top: 75%;
            left: 50%;
        }  

        #div-point {
            position: absolute;
            top: 75%;
            left: 55%;
            width: 10px;
            height: 10px;
            display: block;
            margin: 0;
            align-self: center;
            background-color: red;
            opacity: 0;
            transform: translate(-50%, -50%);
        }

        @media (min-width: 768px) {
            #div-photo {
                width: 35vw;
            }
        }

        @media (min-width: 1024px) {
            #div-photo {
                width: 30vw;
            }
        }

        @media (min-width: 1280px) {
            #div-photo {
                width: 25vw;
            }
        }

        @media (min-width: 1440px) {
            #div-photo {
                width: 25vw;
            }
        }

        @media (min-width: 1600px) {
            #div-photo {
                width: 20vw;
            }
        }

        @media (min-width: 1920px) {
            #div-photo {
                width: 20vw;
            }
        }
    </style>

    <script src="/src/jquery-3.7.1.min.js"></script>
    <script src="./js/optimization.js"></script>
    <script type="text/javascript">

        window.addEventListener("beforeunload", function (event) {
            event.returnValue = "Уверены, что хотите покинуть страницу?";
            return event.returnValue;
        });

        // 
        // CURSOR MOVE CONTROLL
        // 

        const ELEMENT_BUTTON = $('#btn-click')

        // Настройки cursorController
        const SETTINGS = {
            elementCursor: $("#img-cursor"), // 
            timeout: 2, // Задержка перед началом
            stiffness: 0.4, // Жесткость пружины (скорость реакции)
            damping: 0.97, // Затухание (плавность остановки)
            mass: 0.1, // Масса объекта
            // maxSpeed: 0.25, // Максимальная скорость
            maxSpeed: 2.5, // Максимальная скорость
        };

        const Zone = {
            NONE: 0,
            PHOTO: 1,
            BUTTON: 2,
            POINT: 3
        };
        var CurrentZone = Zone.NONE;

        var ElementZones = {
            [Zone.NONE]: null,
            [Zone.PHOTO]: $("#img-portrait"),
            [Zone.BUTTON]: ELEMENT_BUTTON,
            [Zone.POINT]: $('#div-point')
        };

        function updateCurrentZone() {
            if (isCursorInZone(Zone.BUTTON)) {
                if (CurrentZone != Zone.BUTTON) {
                    CurrentZone = Zone.BUTTON;
                    changeSrc(
                        SETTINGS.elementCursor,
                        "./images/pointer.png",
                    );
                    ELEMENT_BUTTON.addClass("hovered");
                    ELEMENT_BUTTON.css("pointer-events", "all");
                }
                return;
            } else {
                if (CurrentZone == Zone.BUTTON) {
                    ELEMENT_BUTTON.removeClass("hovered");
                    ELEMENT_BUTTON.css("pointer-events", "none");
                }
            }
            
            // if (isCursorInZone(Zone.PHOTO)) {
            //     if (CurrentZone != Zone.PHOTO) {
            //         CurrentZone = Zone.PHOTO;
            //         changeSrc(
            //             SETTINGS.elementCursor,
            //             "./images/unavailable.png",
            //         );
            //     }
            //     return;
            // }

             if (CurrentZone != Zone.NONE) {
                CurrentZone = Zone.NONE;
                changeSrc(
                    SETTINGS.elementCursor,
                    "./images/default.png",
                );
                return;
            }
        }

        // 
        // CURSOR CLICK CONTROLL
        // 

        // const LIMIT_CLICK = 1;

        var countClick = 0;
        var IS_CLICKED = false;

        // Инициализация начальной позиции
        window.addEventListener("mousedown", handleClick);

        function disableCursor() {
            window.removeEventListener("mousedown", handleClick);
        }

        async function handleClick(e) {
            if (e.which === 1) {
                // 1 - левая кнопка
                if (CurrentZone == Zone.BUTTON) {
                    await clickButton();
                } else {
                    number = getRandomInt(1, 2);
                    flash([number, 0, number, 0, number, number, number]);
                }
            }
        }

        async function clickButton() {
            if (IS_CLICKED)
                return

            IS_CLICKED = true
            countClick += 1;

            ELEMENT_BUTTON.addClass("active");

            if (isCursorInZone(Zone.POINT)) {

                ELEMENT_BUTTON.css("pointer-events", "none");
                ELEMENT_BUTTON.attr("disabled", true);
                disableCursor()
                stopCursor();

                ELEMENT_BUTTON.addClass("d-none");
                await flash(generateFlashArray(3));
                await flash(generateFlashArray(3));
                ELEMENT_BUTTON.removeClass("d-none");

                ELEMENT_BUTTON.removeClass("hovered");
                ELEMENT_BUTTON.removeClass("active");
                ELEMENT_BUTTON.attr("disabled", true);

                // const LINK = "01index";
                // setTimeout(() => {
                //     window.open(`./${LINK}.html`, "_blank");
                // }, 2000);
            } else {
                setTimeout(() => {
                    ELEMENT_BUTTON.removeClass("active");
                }, 500);
                
            }

            IS_CLICKED = false;
        }

        // 
        // FLASH CONTROLL
        // 

        const FLASH_SETTINGS = {
            duration: 150
        }

        function generateFlashArray(number) {
            return [number, 0, number, 0, number, number, number];
        }

    </script>
    <script src="./js/cursorMoveController.js"></script>
    <script src="./js/flash.js"></script>
    <script src="./js/random.js"></script>
</html>
