server {
    listen 80 default_server;
    listen [::]:80 default_server;

    root /var/www/html;
    index index.html index.htm index.php;
    error_log  /var/log/nginx/error.log;
    access_log /var/log/nginx/access.log;

    server_name _;

    # Базовые заголовки безопасности
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;

    location / {
        try_files $uri $uri/ =404;
    }

    # Изображения - открытый CORS для всех
    location ~* \.(png|jpg|jpeg|webp)$ {
        expires max;
        add_header Cache-Control "public, no-transform";
        
        # Разрешаем доступ с любых доменов
        add_header 'Access-Control-Allow-Origin' "*" always;
        add_header 'Access-Control-Allow-Methods' "GET, OPTIONS" always;
        
        # Обработка OPTIONS запросов
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Max-Age' 86400;
            add_header 'Content-Length' 0;
            add_header 'Content-Type' 'text/plain; charset=utf-8';
            return 204;
        }
    }

    # Блокировка доступа к PSD и JSON файлам
    location ~* \.(psd|json)$ {
        deny all;
        
        # Или возвращаем 404 Not Found (если хотите скрыть факт существования)
        return 404;
        
        # Логируем попытки доступа
        access_log /var/log/nginx/blocked.log;
    }

    # CSS и JS - без CORS или с ограниченным доступом
    location ~* \.(js|css)$ {
        expires max;
        add_header Cache-Control "public, no-transform";
        # Не добавляем CORS заголовки для JS/CSS
    }

    location ~ \.php$ {
        try_files $uri =404;

        # FastCGI для PHP-FPM
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass php:9000; 
        fastcgi_index index.php;

        # Параметры FastCGI
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;

        include fastcgi_params;  
    }

    # Блок для загрузок - защищенный доступ
    location /uploads/ {
        # CORS для загруженных файлов
        add_header 'Access-Control-Allow-Origin' "*" always;
        add_header 'Access-Control-Allow-Methods' "GET, OPTIONS" always;
        add_header 'Vary' 'Origin' always;
        
        # Защита от листинга директорий
        autoindex off;
        
        # Защита от прямого выполнения PHP в uploads
        location ~ \.php$ {
            deny all;
        }
    }

    # Запрет доступа к важным файлам
    location ~ /(\.env|composer\.json|composer\.lock|package\.json|package-lock\.json|README\.md|\.git|\.svn|\.ht) {
        deny all;
        access_log off;
        log_not_found off;
        return 404;
    }

    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
        return 404;
    }

    # Кастомная страница 403
    # location = /403.html {
    #     internal;
    #     root /var/www/html;
    # }
}